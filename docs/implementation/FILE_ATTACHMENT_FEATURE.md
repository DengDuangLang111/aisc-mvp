# èŠå¤©ç•Œé¢æ–‡ä»¶é™„ä»¶æ˜¾ç¤ºåŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ç°åœ¨ä¼šåœ¨èŠå¤©å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºä¸ºæ–‡ä»¶é™„ä»¶å¡ç‰‡ï¼Œç‚¹å‡»å¯ä»¥æ‰“å¼€å·¦ä¾§çš„æ–‡æ¡£æŸ¥çœ‹å™¨ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. æ–‡ä»¶é™„ä»¶å¡ç‰‡
- **è§†è§‰è®¾è®¡**: ç¾è§‚çš„å¡ç‰‡æ ·å¼ï¼ŒåŒ…å«æ–‡ä»¶å›¾æ ‡ã€æ–‡ä»¶åã€å¤§å°å’Œä¸Šä¼ æ—¶é—´
- **äº¤äº’æ•ˆæœ**: é¼ æ ‡æ‚¬åœæ—¶é«˜äº®ï¼Œç‚¹å‡»å¯æ‰“å¼€æ–‡æ¡£
- **æ–‡ä»¶ç±»å‹è¯†åˆ«**: æ ¹æ®æ–‡ä»¶æ‰©å±•åæ˜¾ç¤ºå¯¹åº”å›¾æ ‡
  - ğŸ“„ PDF
  - ğŸ“ Word (doc, docx)
  - ğŸ“Š Excel (xls, xlsx)
  - ğŸ“½ï¸ PowerPoint (ppt, pptx)
  - ğŸ–¼ï¸ å›¾ç‰‡ (jpg, jpeg, png, gif)
  - ğŸ“ å…¶ä»–æ–‡ä»¶

### 2. æ™ºèƒ½æ–‡æ¡£é¢æ¿åˆ‡æ¢
- ç‚¹å‡»æ–‡ä»¶é™„ä»¶è‡ªåŠ¨æ‰“å¼€å·¦ä¾§æ–‡æ¡£æŸ¥çœ‹å™¨ï¼ˆå¦‚æœå·²éšè—ï¼‰
- æ— ç¼é›†æˆåˆ°ç°æœ‰çš„èŠå¤©ç•Œé¢

### 3. æ¶ˆæ¯å¢å¼º
- ä¸Šä¼ æ–‡ä»¶åè‡ªåŠ¨åˆ›å»ºåŒ…å«æ–‡ä»¶é™„ä»¶çš„æ¶ˆæ¯
- æ¶ˆæ¯å†…å®¹ç®€æ´ï¼š`ğŸ“ å·²ä¸Šä¼ æ–‡æ¡£`
- é™„ä»¶å¡ç‰‡ç‹¬ç«‹æ˜¾ç¤ºåœ¨æ¶ˆæ¯æ°”æ³¡ä¸Šæ–¹

## ğŸ—ï¸ å®ç°æ¶æ„

### æ–°å¢ç»„ä»¶

#### 1. FileAttachment ç»„ä»¶
**æ–‡ä»¶**: `apps/web/app/chat/components/FileAttachment.tsx`

```tsx
interface FileAttachmentProps {
  filename: string          // æ–‡ä»¶å
  fileUrl?: string         // æ–‡ä»¶ URL
  fileSize?: number        // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  uploadTime?: number      // ä¸Šä¼ æ—¶é—´ï¼ˆæ—¶é—´æˆ³ï¼‰
  onClick?: () => void     // ç‚¹å‡»å›è°ƒ
}
```

**åŠŸèƒ½**:
- æ–‡ä»¶å›¾æ ‡æ˜¾ç¤º
- æ–‡ä»¶ä¿¡æ¯å±•ç¤ºï¼ˆåç§°ã€å¤§å°ã€æ—¶é—´ï¼‰
- æ‚¬åœåŠ¨ç”»æ•ˆæœ
- å¯ç‚¹å‡»äº¤äº’

### ä¿®æ”¹çš„ç±»å‹å®šä¹‰

#### Message ç±»å‹å¢å¼º
**æ–‡ä»¶**: `apps/web/app/chat/components/MessageBubble.tsx`

```tsx
interface FileAttachmentData {
  filename: string
  fileUrl?: string
  documentId?: string
  fileSize?: number
  uploadTime?: number
}

interface Message {
  role: 'user' | 'assistant'
  content: string
  hintLevel?: 1 | 2 | 3
  conversationId?: string
  timestamp?: number
  attachment?: FileAttachmentData  // æ–°å¢ï¼šæ–‡ä»¶é™„ä»¶
}
```

### ä¿®æ”¹çš„ç»„ä»¶

#### 1. MessageBubble
- æ–°å¢ `onFileClick` å›è°ƒå±æ€§
- åœ¨æ¶ˆæ¯æ°”æ³¡ä¸Šæ–¹æ˜¾ç¤ºæ–‡ä»¶é™„ä»¶
- å¤„ç†æ–‡ä»¶ç‚¹å‡»äº‹ä»¶

#### 2. MessageList
- ä¼ é€’ `onFileClick` å›è°ƒç»™æ‰€æœ‰æ¶ˆæ¯æ°”æ³¡
- åŒ…æ‹¬æµå¼æ¶ˆæ¯

#### 3. ChatLayout
- å®ç° `handleFileClick` å‡½æ•°
- å½“ç‚¹å‡»æ–‡ä»¶é™„ä»¶æ—¶ï¼Œå¦‚æœæ–‡æ¡£é¢æ¿éšè—åˆ™è‡ªåŠ¨æ‰“å¼€
- æ¥æ”¶å¹¶ä¼ é€’ `onToggleDocument` å›è°ƒ

#### 4. useChatLogic Hook
- ä¿®æ”¹ `handleFileSelect` å‡½æ•°
- åˆ›å»ºåŒ…å«æ–‡ä»¶é™„ä»¶çš„æ¶ˆæ¯ï¼š
  ```tsx
  const systemMessage: Message = {
    role: 'user',
    content: `ğŸ“ å·²ä¸Šä¼ æ–‡æ¡£`,
    timestamp: Date.now(),
    attachment: {
      filename: file.name,
      fileUrl: uploadResponse.url,
      documentId: newDocumentId,
      fileSize: file.size,
      uploadTime: Date.now(),
    },
  }
  ```

## ğŸ“¸ UI å±•ç¤º

### æ–‡ä»¶é™„ä»¶å¡ç‰‡æ ·å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„  sample-document.pdf                â”‚
â”‚      ğŸ“¦ 2.45 MB    ğŸ• 14:30            â”‚
â”‚                                    ğŸ‘ï¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ­£å¸¸çŠ¶æ€**: ç™½è‰²èƒŒæ™¯ï¼Œç°è‰²è¾¹æ¡†
**æ‚¬åœçŠ¶æ€**: è“è‰²è¾¹æ¡†ï¼Œæµ…è“è‰²èƒŒæ™¯ï¼Œé˜´å½±å¢å¼º

### æ¶ˆæ¯æµ

```
ç”¨æˆ·æ¶ˆæ¯ (å³å¯¹é½):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„  sample-document.pdf                â”‚
â”‚      ğŸ“¦ 2.45 MB    ğŸ• 14:30            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ å·²ä¸Šä¼ æ–‡æ¡£          â”‚  (è“è‰²æ¸å˜)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AI å›å¤ (å·¦å¯¹é½):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆ‘å·²ç»æ”¶åˆ°æ‚¨çš„æ–‡æ¡£ã€‚è¯·é—®æ‚¨æƒ³è¦æˆ‘    â”‚
â”‚ å¸®æ‚¨åšä»€ä¹ˆï¼Ÿ                         â”‚  (ç°è‰²)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: é¦–æ¬¡ä¸Šä¼ æ–‡ä»¶
1. ç”¨æˆ·ç‚¹å‡»ä¸Šä¼ æŒ‰é’®ï¼Œé€‰æ‹©æ–‡ä»¶
2. æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼ŒèŠå¤©æ¡†ä¸­æ˜¾ç¤ºæ–‡ä»¶é™„ä»¶å¡ç‰‡
3. ç”¨æˆ·å¯ä»¥ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹æ–‡æ¡£å†…å®¹
4. å·¦ä¾§è‡ªåŠ¨æ‰“å¼€æ–‡æ¡£æŸ¥çœ‹å™¨

### åœºæ™¯ 2: é‡æ–°æŸ¥çœ‹å·²ä¸Šä¼ æ–‡ä»¶
1. ç”¨æˆ·åœ¨èŠå¤©å†å²ä¸­çœ‹åˆ°ä¹‹å‰ä¸Šä¼ çš„æ–‡ä»¶
2. ç‚¹å‡»æ–‡ä»¶é™„ä»¶å¡ç‰‡
3. å¦‚æœæ–‡æ¡£é¢æ¿å·²éšè—ï¼Œè‡ªåŠ¨å±•å¼€
4. å·¦ä¾§æ˜¾ç¤ºæ–‡æ¡£å†…å®¹

### åœºæ™¯ 3: å¤šæ–‡ä»¶å¯¹è¯
1. ç”¨æˆ·ä¸Šä¼ ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ–‡æ¡£ Aï¼‰
2. èŠå¤©å‡ è½®åï¼Œä¸Šä¼ ç¬¬äºŒä¸ªæ–‡ä»¶ï¼ˆæ–‡æ¡£ Bï¼‰
3. èŠå¤©å†å²ä¸­ä¿ç•™ä¸¤ä¸ªæ–‡ä»¶é™„ä»¶å¡ç‰‡
4. ç‚¹å‡»ä»»æ„æ–‡ä»¶å¡ç‰‡å¯åˆ‡æ¢æŸ¥çœ‹å¯¹åº”æ–‡æ¡£

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. çŠ¶æ€ç®¡ç†
- æ–‡ä»¶ä¿¡æ¯å­˜å‚¨åœ¨æ¶ˆæ¯çš„ `attachment` å­—æ®µ
- é€šè¿‡ `ChatStorage` æŒä¹…åŒ–åˆ° localStorage
- é¡µé¢åˆ·æ–°åä¿ç•™æ–‡ä»¶é™„ä»¶ä¿¡æ¯

### 2. å›è°ƒä¼ é€’é“¾
```
useChatLogic
  â†“
ChatLayout (handleFileClick)
  â†“
MessageList (onFileClick)
  â†“
MessageBubble (onFileClick)
  â†“
FileAttachment (onClick)
```

### 3. æ–‡æ¡£é¢æ¿æ§åˆ¶
```typescript
const handleFileClick = () => {
  if (!showDocument && hasDocument && onToggleDocument) {
    onToggleDocument(); // æ‰“å¼€æ–‡æ¡£é¢æ¿
  }
};
```

### 4. æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
```typescript
const formatFileSize = (bytes?: number) => {
  if (!bytes) return ''
  const mb = bytes / (1024 * 1024)
  return mb.toFixed(2) + ' MB'
}
```

### 5. æ—¶é—´æ ¼å¼åŒ–
```typescript
const formatTime = (timestamp?: number) => {
  if (!timestamp) return ''
  const date = new Date(timestamp)
  return date.toLocaleTimeString('zh-CN', {
    hour: '2-digit',
    minute: '2-digit',
  })
}
```

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `apps/web/app/chat/components/FileAttachment.tsx` (132 è¡Œ)

### ä¿®æ”¹æ–‡ä»¶
1. `apps/web/app/chat/components/MessageBubble.tsx`
   - æ·»åŠ  `FileAttachmentData` æ¥å£
   - ä¿®æ”¹ `Message` æ¥å£
   - æ·»åŠ  `onFileClick` å±æ€§
   - æ¸²æŸ“æ–‡ä»¶é™„ä»¶å¡ç‰‡

2. `apps/web/app/chat/components/MessageList.tsx`
   - æ·»åŠ  `onFileClick` å±æ€§
   - ä¼ é€’å›è°ƒç»™æ‰€æœ‰æ¶ˆæ¯

3. `apps/web/app/chat/components/ChatLayout.tsx`
   - æ·»åŠ  `onToggleDocument` å±æ€§
   - å®ç° `handleFileClick` å‡½æ•°
   - ä¼ é€’å›è°ƒç»™ MessageList

4. `apps/web/app/chat/page.tsx`
   - ä¼ é€’ `onToggleDocument` ç»™ ChatLayout

5. `apps/web/app/chat/hooks/useChatLogic.ts`
   - ä¿®æ”¹ `handleFileSelect` å‡½æ•°
   - åˆ›å»ºåŒ…å«é™„ä»¶çš„æ¶ˆæ¯

## âœ… æµ‹è¯•éªŒè¯

### ç¼–è¯‘æµ‹è¯•
```bash
âœ“ Compiled successfully in 3.8s
âœ“ Running TypeScript
âœ“ Generating static pages (11/11)
```

### åŠŸèƒ½æµ‹è¯•æ¸…å•
- [ ] ä¸Šä¼  PDF æ–‡ä»¶ï¼ŒæŸ¥çœ‹æ–‡ä»¶é™„ä»¶å¡ç‰‡æ˜¾ç¤º
- [ ] ç‚¹å‡»æ–‡ä»¶é™„ä»¶ï¼Œç¡®è®¤æ–‡æ¡£é¢æ¿æ‰“å¼€
- [ ] æµ‹è¯•ä¸åŒæ–‡ä»¶ç±»å‹çš„å›¾æ ‡æ˜¾ç¤º
- [ ] éªŒè¯æ–‡ä»¶å¤§å°å’Œæ—¶é—´æ ¼å¼åŒ–
- [ ] æµ‹è¯•æ‚¬åœæ•ˆæœå’ŒåŠ¨ç”»
- [ ] åˆ·æ–°é¡µé¢åéªŒè¯é™„ä»¶ä¿¡æ¯ä¿ç•™
- [ ] æµ‹è¯•å¤šæ–‡ä»¶ä¸Šä¼ åœºæ™¯

## ğŸ¨ æ ·å¼ç‰¹æ€§

### æ‚¬åœåŠ¨ç”»
```css
transition-all
hover:shadow-md
hover:border-blue-400
hover:bg-blue-50
hover:scale-110  (å›¾æ ‡)
```

### å“åº”å¼è®¾è®¡
- å¡ç‰‡å®½åº¦è‡ªé€‚åº”
- æ–‡ä»¶åè‡ªåŠ¨æˆªæ–­ï¼ˆtruncateï¼‰
- ç§»åŠ¨ç«¯å‹å¥½çš„è§¦æ‘¸ç›®æ ‡

### æ— éšœç¢æ”¯æŒ
- `role="button"` è¯­ä¹‰åŒ–
- `tabIndex` é”®ç›˜å¯¼èˆª
- `onKeyDown` æ”¯æŒ Enter/Space é”®

## ğŸš€ æœªæ¥ä¼˜åŒ–å»ºè®®

1. **æ‹–æ‹½ä¸Šä¼ å¢å¼º**: æ‹–æ‹½æ–‡ä»¶åˆ°é™„ä»¶å¡ç‰‡å¯æ›¿æ¢æ–‡ä»¶
2. **æ–‡ä»¶é¢„è§ˆ**: é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆç¼©ç•¥å›¾
3. **ä¸‹è½½åŠŸèƒ½**: æ·»åŠ ä¸‹è½½æŒ‰é’®ç›´æ¥ä¸‹è½½æ–‡ä»¶
4. **åˆ†äº«é“¾æ¥**: ç”Ÿæˆæ–‡ä»¶åˆ†äº«é“¾æ¥
5. **æ–‡ä»¶ç®¡ç†**: æ‰¹é‡ç®¡ç†ä¸Šä¼ çš„æ–‡ä»¶
6. **æ–‡ä»¶å¤¹æ”¯æŒ**: æ”¯æŒæ–‡ä»¶å¤¹ç»“æ„æ˜¾ç¤º
7. **æœç´¢åŠŸèƒ½**: åœ¨èŠå¤©å†å²ä¸­æœç´¢ç‰¹å®šæ–‡ä»¶

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœ¨æ¶ˆæ¯ä¸­ä½¿ç”¨æ–‡ä»¶é™„ä»¶

```tsx
const messageWithAttachment: Message = {
  role: 'user',
  content: 'è¿™æ˜¯æˆ‘çš„æŠ¥å‘Šï¼Œè¯·å¸®æˆ‘å®¡é˜…',
  timestamp: Date.now(),
  attachment: {
    filename: 'report.pdf',
    fileUrl: 'https://example.com/files/report.pdf',
    documentId: 'doc-123',
    fileSize: 2 * 1024 * 1024, // 2MB
    uploadTime: Date.now(),
  },
}
```

### è‡ªå®šä¹‰æ–‡ä»¶ç‚¹å‡»è¡Œä¸º

```tsx
<MessageBubble
  message={message}
  onFileClick={(fileUrl, filename) => {
    console.log('File clicked:', filename)
    // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
    window.open(fileUrl, '_blank')
  }}
/>
```

---

**å®æ–½æ—¥æœŸ**: 2025-11-04  
**çŠ¶æ€**: âœ… å®Œæˆ  
**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸ  
**å¾…æµ‹è¯•**: åŠŸèƒ½æµ‹è¯•ã€ç”¨æˆ·ä½“éªŒæµ‹è¯•
