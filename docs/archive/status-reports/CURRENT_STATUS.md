# ğŸš€ ç³»ç»Ÿå½“å‰çŠ¶æ€ (2025-01-02)

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. API é…ç½®ä¿®å¤
- **é—®é¢˜**: NestJS monorepo æ„å»ºè·¯å¾„é”™è¯¯
- **è§£å†³**: 
  - ä¿®æ”¹ `tsconfig.json` (module: commonjs)
  - ä¿®æ”¹ `nest-cli.json` (æ·»åŠ  exec é…ç½®)
  - ä¿®æ”¹ `package.json` (æ›´æ–° start è„šæœ¬)
  - åˆ é™¤ `main.ts` ä¸­çš„é‡å¤ `bootstrap()` è°ƒç”¨
- **çŠ¶æ€**: âœ… å®Œæˆ

### 2. æœåŠ¡å™¨å¯åŠ¨
- **API**: âœ… è¿è¡Œä¸­
  - ç«¯å£: 4001
  - è¿›ç¨‹ ID: 57948
  - å¥åº·æ£€æŸ¥: http://localhost:4001/health
  - Swagger æ–‡æ¡£: http://localhost:4001/api-docs
  
- **å‰ç«¯**: âœ… è¿è¡Œä¸­
  - ç«¯å£: 3000
  - è¿›ç¨‹ ID: 62956, 63011
  - è®¿é—®åœ°å€: http://localhost:3000
  - é¡µé¢æ ‡é¢˜: "Study Oasis å­¦ä¹ ç»¿æ´²"

### 3. å‰ç«¯é…ç½®
- **é—®é¢˜**: API URL ç«¯å£é”™è¯¯ (4000 â†’ 4001)
- **è§£å†³**: æ›´æ–° `apps/web/.env.local`
- **çŠ¶æ€**: âœ… å®Œæˆ

---

## âš ï¸ å¾…è§£å†³é—®é¢˜

### æ•°æ®åº“ Schema ä¸åŒ¹é…

**é—®é¢˜æè¿°**:
- `analytics_events` è¡¨ç¼ºå°‘ `sessionId` åˆ—
- å¯¼è‡´æ‰€æœ‰ API ç«¯ç‚¹è¿”å› 500/400 é”™è¯¯
- å½±å“æ–‡ä»¶ä¸Šä¼ å’Œ AI èŠå¤©åŠŸèƒ½

**é”™è¯¯ä¿¡æ¯**:
```
Column `sessionId` does not exist in the current database
```

**å½±å“èŒƒå›´**:
- âŒ POST /api/files/upload - 500 Internal Server Error
- âŒ POST /api/chat - 400 Bad Request
- âœ… GET /api/health - æ­£å¸¸

**æ ¹æœ¬åŸå› **:
- Prisma schema å®šä¹‰äº† `sessionId` å­—æ®µ
- ä½† Supabase æ•°æ®åº“ä¸­çš„è¡¨æ²¡æœ‰è¿™ä¸ªåˆ—
- `prisma.config.js` è§£æé”™è¯¯ï¼Œé˜»æ­¢è‡ªåŠ¨è¿ç§»

---

## ğŸ”§ éœ€è¦æ‰‹åŠ¨æ“ä½œ

### æ­¥éª¤ 1: åœ¨ Supabase æ§åˆ¶å°æ‰§è¡Œ SQL

1. **ç™»å½• Supabase**:
   - è®¿é—®: https://supabase.com/dashboard
   - ç™»å½•ä½ çš„è´¦æˆ·

2. **æ‰¾åˆ°é¡¹ç›®**:
   - é€‰æ‹©ä½ çš„ Study Oasis é¡¹ç›®

3. **æ‰“å¼€ SQL Editor**:
   - å·¦ä¾§èœå• â†’ SQL Editor
   - ç‚¹å‡» "New Query"

4. **å¤åˆ¶å¹¶æ‰§è¡Œä»¥ä¸‹ SQL**:
   ```sql
   -- æ·»åŠ  sessionId åˆ—
   ALTER TABLE analytics_events 
   ADD COLUMN IF NOT EXISTS "sessionId" TEXT NOT NULL 
   DEFAULT gen_random_uuid()::text;

   -- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
   CREATE INDEX IF NOT EXISTS idx_analytics_events_session 
   ON analytics_events("sessionId", "createdAt");

   -- éªŒè¯ä¿®æ”¹
   SELECT column_name, data_type, is_nullable 
   FROM information_schema.columns 
   WHERE table_name = 'analytics_events'
   ORDER BY ordinal_position;
   ```

5. **éªŒè¯ç»“æœ**:
   - ä½ åº”è¯¥çœ‹åˆ° SQL æˆåŠŸæ‰§è¡Œ
   - æœ€åä¸€ä¸ªæŸ¥è¯¢ä¼šæ˜¾ç¤ºè¡¨çš„æ‰€æœ‰åˆ—
   - ç¡®è®¤ `sessionId` åˆ—å­˜åœ¨

---

## ğŸ“‹ æ‰§è¡Œå®Œ SQL åçš„ä¸‹ä¸€æ­¥

**æ‰§è¡Œå®Œä¸Šè¿° SQL åï¼Œå‘Šè¯‰æˆ‘ä¸€å£°ï¼Œæˆ‘ä¼šç«‹å³ï¼š**

1. âœ… é‡å¯ API æœåŠ¡å™¨
2. âœ… è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
3. âœ… éªŒè¯æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
4. âœ… éªŒè¯ AI èŠå¤©åŠŸèƒ½
5. âœ… ç¡®è®¤ç«¯åˆ°ç«¯æµç¨‹å·¥ä½œ

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

SQL æ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä¼šæµ‹è¯•ï¼š

### 1. æ–‡ä»¶ä¸Šä¼ 
```bash
curl -X POST http://localhost:4001/api/files/upload \
  -F "file=@test.txt" \
  -F "metadata={}"
```
**é¢„æœŸ**: è¿”å› `{"documentId": "...", "fileUrl": "..."}`

### 2. AI èŠå¤© (æ— æ–‡æ¡£)
```bash
curl -X POST http://localhost:4001/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ä½ å¥½", "conversationId": null}'
```
**é¢„æœŸ**: è¿”å› `{"reply": "...", "conversationId": "..."}`

### 3. AI èŠå¤© (å¸¦æ–‡æ¡£)
ä¸Šä¼ æ–‡ä»¶åï¼Œä½¿ç”¨è¿”å›çš„ documentId è¿›è¡ŒèŠå¤©
**é¢„æœŸ**: AI èƒ½æ ¹æ®æ–‡æ¡£å†…å®¹å›ç­”é—®é¢˜

### 4. å‰ç«¯æµ‹è¯•
- è®¿é—® http://localhost:3000
- æµ‹è¯•æ–‡ä»¶ä¸Šä¼ é¡µé¢
- æµ‹è¯• AI èŠå¤©é¡µé¢

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
Frontend (Next.js 16)     Backend (NestJS 11)      External Services
Port: 3000                Port: 4001                
                                                     
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚          â”‚              â”‚         â”‚  Supabase    â”‚
â”‚  React UI    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  API Server  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  PostgreSQL  â”‚
â”‚              â”‚          â”‚              â”‚         â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                   
                                â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  DeepSeek AI â”‚
                                â”‚                   â”‚  API         â”‚
                                â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                   
                                â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Google      â”‚
                                                    â”‚  Cloud Visionâ”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æµç¨‹

### æ–‡ä»¶ä¸Šä¼  + AI é—®ç­”æµç¨‹
1. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ (PDF/å›¾ç‰‡/æ–‡æ¡£)
2. åç«¯ä¿å­˜åˆ° Google Cloud Storage
3. Google Cloud Vision è¿›è¡Œ OCR æå–æ–‡æœ¬
4. æå–çš„æ–‡æœ¬å­˜å‚¨åˆ° Supabase
5. ç”¨æˆ·æé—®
6. ç³»ç»Ÿå°†æ–‡æ¡£å†…å®¹ + ç”¨æˆ·é—®é¢˜å‘é€ç»™ DeepSeek AI
7. AI è¿”å›åŸºäºæ–‡æ¡£å†…å®¹çš„å›ç­”

---

## ğŸ” è¯Šæ–­å·¥å…·

### æŸ¥çœ‹ API æ—¥å¿—
```bash
tail -f /tmp/api.log
```

### æŸ¥çœ‹å‰ç«¯æ—¥å¿—
```bash
tail -f /tmp/web.log
```

### æ£€æŸ¥ API å¥åº·çŠ¶æ€
```bash
curl http://localhost:4001/health
```

### æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
```bash
ps aux | grep -E "node.*main|pnpm.*dev"
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **SQL è¿ç§»**: `/docs/database/fix-analytics-table.sql`
- **è¯¦ç»†æŒ‡å—**: `/API_FIX_GUIDE.md`
- **å¿«é€ŸæŒ‡å—**: `/NEXT_STEP.md`
- **æµ‹è¯•è„šæœ¬**: `/test-api.sh`
- **API å¯åŠ¨è„šæœ¬**: `/start-api.sh`

---

## â° é¢„è®¡æ—¶é—´

- **SQL æ‰§è¡Œ**: 1 åˆ†é’Ÿ
- **é‡å¯ + æµ‹è¯•**: 2-3 åˆ†é’Ÿ
- **æ€»è®¡**: 5 åˆ†é’Ÿå†…å®Œæˆæ‰€æœ‰ä¿®å¤

---

**ç°åœ¨è¯·æ‰§è¡Œ SQLï¼Œç„¶åå‘Šè¯‰æˆ‘ "SQL æ‰§è¡Œå®Œæ¯•"ï¼Œæˆ‘ä¼šç«‹å³ç»§ç»­ï¼** ğŸš€
