# 📌 Study Oasis 产品功能 TODO 清单

**最后更新**：2025-11-02  
**产品阶段**：Phase 4 - 核心功能完善  
**总体进度**：60% 完成

---

## 🎯 核心功能需求总结

基于产品 PRD 分析，Study Oasis 需要以下功能：

### ✅ 已完成（60%）

#### 后端服务 (100% 完成)
- ✅ **文件上传模块**
  - Google Cloud Storage 集成
  - 文件安全验证
  - Signed URL 生成
  
- ✅ **OCR 文本识别**
  - Google Cloud Vision API 集成
  - 文本提取和存储
  - 元数据保存
  
- ✅ **AI 对话引擎**
  - DeepSeek API 集成
  - 3 级渐进式提示系统
  - 对话历史持久化
  - 消息加载和上下文管理
  
- ✅ **数据分析系统**
  - 事件追踪（40+ 事件类型）
  - Token 使用统计
  - 用户行为分析
  
- ✅ **数据库**
  - Supabase PostgreSQL
  - 8 张核心表
  - 关系建模

#### 前端基础 (50% 完成)
- ✅ 首页展示
- ✅ 文件上传界面
- 🟡 AI 对话界面（缺少历史管理）
- ❌ 对话列表页面
- ❌ 文档管理页面
- ❌ 用户仪表板

---

## 🔧 需要完成的功能清单

### 第 1 阶段：核心功能修复（P0 高优先级）

#### Task 1.1 - 修复对话上下文（这周）
- [ ] **问题**：用户连续提问时，对话历史丢失
- [ ] **原因**：前端未维护 `conversationId` 状态
- [ ] **方案**：
  - 在对话页面添加状态管理
  - 第一次提问创建会话，返回 `conversationId`
  - 后续消息传递 `conversationId`
  - 加载完整对话历史
- [ ] **文件**：`/apps/web/app/chat/page.tsx`
- [ ] **预期结果**：用户能在同一对话中连续提问，AI 能访问历史

#### Task 1.2 - 验证 OCR 功能（这周）
- [ ] **检查**：Google Cloud Vision API 是否正常工作
- [ ] **验证步骤**：
  ```bash
  # 1. 列出所有文档
  curl http://localhost:4001/upload/documents
  
  # 2. 查看 OCR 结果
  curl http://localhost:4001/upload/documents/{id}/ocr
  
  # 3. 检查数据库
  SELECT * FROM ocr_results LIMIT 1;
  ```
- [ ] **预期结果**：OCR 能正确识别文本内容

---

### 第 2 阶段：前端界面完善（P0 高优先级）

#### Task 2.1 - 完善对话界面
- [ ] **页面**：`/chat` 页面重构
- [ ] **功能**：
  - 显示完整对话历史（所有消息）
  - 支持向上滚动加载更多
  - 显示 Hint Level 指示器（Light/Coach/Advisor）
  - 显示消息时间戳
  - 支持消息复制
- [ ] **界面布局**：
  ```
  ┌─────────────────────────────┐
  │ 对话历史（向上滚动加载）     │ ← 加载更多
  ├─────────────────────────────┤
  │ 消息 1（用户）- 05:28       │
  │ 消息 2（AI）- Level 1       │
  │ 消息 3（用户）- 05:41       │
  │ 消息 4（AI）- Level 1       │
  ├─────────────────────────────┤
  │ 输入框 + 发送按钮           │
  └─────────────────────────────┘
  ```
- [ ] **预期结果**：用户能清晰看到完整对话过程

#### Task 2.2 - 实现对话列表页面
- [ ] **页面**：`/chat/conversations` 
- [ ] **功能**：
  - 显示所有对话列表
  - 每个对话显示标题、最后消息、时间
  - 支持点击进入对话
  - 支持删除对话
  - 支持新建对话
  - 按时间排序
- [ ] **预期结果**：用户能管理多个对话

#### Task 2.3 - 实现文档管理页面
- [ ] **页面**：`/documents`
- [ ] **功能**：
  - 显示所有上传的文档
  - 显示 OCR 状态（处理中/完成/失败）
  - 查看 OCR 结果预览
  - 删除文档
  - 关联对话
  - 显示识别进度
- [ ] **预期结果**：用户能查看和管理所有文档

---

### 第 3 阶段：用户管理和认证（P1 中优先级）

#### Task 3.1 - 实现用户认证系统
- [ ] **功能**：
  - 用户注册页面
  - 用户登录页面
  - JWT Token 认证
  - 用户隔离（只能看到自己的数据）
  - 用户信息管理
- [ ] **端点**：
  ```
  POST /auth/register - 注册
  POST /auth/login - 登录
  POST /auth/logout - 登出
  GET /auth/me - 获取当前用户
  PUT /auth/profile - 更新用户信息
  ```
- [ ] **预期结果**：用户能安全地使用系统

#### Task 3.2 - 实现用户仪表板
- [ ] **页面**：`/dashboard`
- [ ] **数据展示**：
  - API 使用成本统计
  - Token 消耗总数
  - 对话总数
  - 文档总数
  - 用户行为图表
  - 趋势分析
- [ ] **预期结果**：用户能了解使用情况

---

### 第 4 阶段：高级功能（P2 低优先级）

#### Task 4.1 - 实现流式响应
- [ ] **技术**：WebSocket 或 Server-Sent Events (SSE)
- [ ] **效果**：打字机效果，逐字显示 AI 回复
- [ ] **文件**：
  - 后端：`apps/api/src/chat/chat.gateway.ts` (WebSocket)
  - 前端：`apps/web/lib/websocket/client.ts`
- [ ] **预期结果**：改进用户体验

#### Task 4.2 - 添加文件上传到对话流程
- [ ] **功能**：
  - 在对话中支持上传文件
  - 文件立即作为上下文
  - 显示上传进度
  - 多文件支持
- [ ] **预期结果**：用户能更灵活地使用系统

#### Task 4.3 - 实现搜索功能
- [ ] **搜索对象**：
  - 对话历史
  - 文档内容
  - OCR 结果
- [ ] **预期结果**：用户能快速找到需要的信息

#### Task 4.4 - 实现导出功能
- [ ] **导出格式**：PDF、Word、Markdown
- [ ] **导出内容**：
  - 对话记录
  - 文档笔记
  - 学习总结
- [ ] **预期结果**：用户能保存学习成果

#### Task 4.5 - 前端性能优化
- [ ] 代码分割和懒加载
- [ ] 图片优化
- [ ] 缓存策略
- [ ] 防抖节流
- [ ] 虚拟滚动（长对话列表）
- [ ] 预期结果：提升加载速度

#### Task 4.6 - 错误处理和重试机制
- [ ] API 错误处理
- [ ] 网络异常处理
- [ ] 自动重试
- [ ] 用户友好的错误提示
- [ ] 预期结果：提升系统稳定性

#### Task 4.7 - 音频/语音识别（未来）
- [ ] 语音转文字 API 集成
- [ ] 语音输入按钮
- [ ] 实时语音处理
- [ ] 预期结果：支持语音学习

#### Task 4.8 - 优化提示词系统
- [ ] 按学科定制提示词（数学、英语、科学等）
- [ ] 按难度调整
- [ ] 按学生水平调整
- [ ] 预期结果：更个性化的学习体验

---

## 📊 功能完成度统计

| 模块 | 完成度 | 备注 |
|------|--------|------|
| 后端 API | 100% | 所有核心端点已实现 |
| 数据库 | 100% | 所有表已创建和优化 |
| OCR 集成 | 100% | Google Cloud Vision 已集成 |
| AI 对话 | 100% | DeepSeek 已集成，提示词完善 |
| 前端基础 | 50% | 首页和上传页面完成 |
| 对话界面 | 40% | 缺少历史管理 |
| 用户认证 | 0% | 未开始 |
| 用户仪表板 | 0% | 未开始 |
| 流式响应 | 0% | 未开始 |
| **总体** | **60%** | 核心功能已完成，UI 待完善 |

---

## 📝 当前关键问题

### 🔴 P0 级（阻塞功能）

1. **对话上下文缺失**
   - 影响：用户连续提问时无法看到历史
   - 严重性：高（影响基础使用）
   - 修复难度：低（前端状态管理）

2. **OCR 验证**
   - 影响：不确定文件内容提取是否正常
   - 严重性：中（需要数据验证）
   - 修复难度：低（API 调用测试）

### 🟡 P1 级（影响体验）

3. **对话列表缺失**
   - 影响：用户无法管理多个对话
   - 严重性：中
   - 修复难度：中

4. **缺少用户认证**
   - 影响：用户数据不隔离
   - 严重性：高（安全问题）
   - 修复难度：高

---

## 🚀 建议优先级排序

### 第 1 周（紧急）
1. ✅ 修复对话上下文（P0）
2. ✅ 验证 OCR 功能（P0）
3. ✅ 完善对话界面（P0）

### 第 2 周（高优先）
4. 实现对话列表页面（P1）
5. 实现文档管理页面（P1）
6. 添加用户认证（P1）

### 第 3-4 周（中优先）
7. 实现用户仪表板（P2）
8. 实现流式响应（P2）
9. 添加搜索功能（P2）

### 第 5 周以后（低优先）
10. 实现导出功能（P3）
11. 前端性能优化（P3）
12. 音频识别（P4）

---

## 📞 团队协作建议

### 后端开发者
- ✅ 已完成所有关键端点
- 📋 建议：编写 API 文档、优化错误处理、准备用户认证端点

### 前端开发者
- 🔴 **立即**：修复对话上下文问题
- ✅ **其次**：完善对话界面
- 📋 **然后**：开发对话列表和文档管理页面

### 产品经理
- 📊 建议收集用户反馈
- 🎯 优化提示词内容（根据学科）
- 📈 规划下一阶段功能

---

## 📖 相关文档

- [系统诊断报告](./DIAGNOSTIC_REPORT.md) - 问题分析
- [系统运行状态](./SYSTEM_OPERATIONAL.md) - 当前运行情况
- [API 文档](./README_NEW.md) - API 使用说明
- [项目架构](./docs/architecture/) - 技术架构

---

**下一步行动**：
1. 运行诊断命令验证 OCR
2. 修复前端对话状态管理
3. 完善对话界面
4. 开始对话列表开发

**预计完成周期**：第 1 阶段 3-5 天，第 2 阶段 1-2 周
