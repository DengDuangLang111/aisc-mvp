# AI API 接入检查清单

快速跟踪进度使用。

---

## 📋 准备阶段

### 账号注册
- [ ] 注册智谱 AI 账号 (https://open.bigmodel.cn/)
- [ ] 获取 API Key
- [ ] 充值测试额度（建议 ¥50）
- [ ] 测试 API 连通性

### 环境配置
- [ ] 创建 `apps/api/.env` 文件
- [ ] 创建 `apps/web/.env.local` 文件
- [ ] 更新 `.gitignore` 忽略环境变量文件
- [ ] 创建 `.env.example` 模板文件

---

## 🔧 后端开发

### 依赖安装
- [ ] `pnpm add openai` - OpenAI SDK（兼容智谱）
- [ ] `pnpm add @nestjs/config` - 环境变量管理
- [ ] `pnpm add pdf-parse` - PDF 文本提取
- [ ] `pnpm add @nestjs/throttler` - API 限流

### AI 模块创建
- [ ] 创建 `src/ai/ai.module.ts`
- [ ] 创建 `src/ai/ai.service.ts`
- [ ] 创建 `src/ai/ai.types.ts`
- [ ] 实现 OpenAI 客户端初始化

### Chat 服务重构
- [ ] 更新 `chat.service.ts` - 集成 AI API
- [ ] 实现系统提示词模板（3 个等级）
- [ ] 实现对话历史管理
- [ ] 实现渐进式提示逻辑
- [ ] 添加错误处理和重试

### Upload 服务增强
- [ ] 更新 `upload.service.ts` - 添加文档解析
- [ ] 实现 PDF 文本提取
- [ ] 实现文本文件读取
- [ ] 添加文档内容缓存
- [ ] 文件类型验证

### 配置管理
- [ ] 创建 `src/config/configuration.ts`
- [ ] 实现环境变量验证
- [ ] 配置 CORS 白名单
- [ ] 配置文件上传限制

### API 路由
- [ ] `POST /chat` - 发送消息（现有，需更新）
- [ ] `POST /chat/stream` - 流式响应（新增）
- [ ] `POST /document/extract` - 提取文档内容（新增）
- [ ] `POST /upload` - 上传文档（现有）

---

## 💻 前端开发

### 依赖安装
- [ ] `pnpm add react-markdown remark-gfm` - Markdown 渲染
- [ ] `pnpm add react-syntax-highlighter` - 代码高亮
- [ ] `pnpm add katex react-katex` - 数学公式（可选）

### API 客户端
- [ ] 创建 `lib/api-client.ts`
- [ ] 封装 `chat()` 方法
- [ ] 封装 `streamChat()` 方法
- [ ] 封装 `uploadFile()` 方法
- [ ] 统一错误处理

### 聊天页面增强
- [ ] 实现流式响应接收
- [ ] 添加打字机效果
- [ ] 添加 Markdown 渲染
- [ ] 添加代码高亮
- [ ] 添加取消请求功能

### 错误处理
- [ ] API 超时处理
- [ ] 网络错误提示
- [ ] 限流错误提示
- [ ] 重试机制
- [ ] 友好的错误消息

### UI/UX 优化
- [ ] "正在思考..." 加载动画
- [ ] 骨架屏占位
- [ ] 消息发送后清空输入框
- [ ] 支持 Shift+Enter 换行
- [ ] 滚动到最新消息

---

## 🧪 测试

### 单元测试
- [ ] AI Service 测试（Mock API）
- [ ] Chat Service 提示等级测试
- [ ] 文档解析测试
- [ ] API Client 测试

### 集成测试
- [ ] 完整对话流程测试
- [ ] 文件上传到对话流程
- [ ] 渐进式提示切换测试
- [ ] 长对话测试（10+ 轮）

### 功能测试
- [ ] 测试不同文件类型（PDF, TXT, MD）
- [ ] 测试不同提示等级
- [ ] 测试错误场景
- [ ] 测试并发请求

---

## 🔒 安全检查

### API 安全
- [ ] API Key 不在代码中
- [ ] API Key 不在 Git 历史中
- [ ] 前端不直接调用 AI API
- [ ] 日志不输出敏感信息

### 输入验证
- [ ] 用户输入长度限制
- [ ] 文件类型白名单
- [ ] 文件大小限制（10MB）
- [ ] 防注入攻击

### Rate Limiting
- [ ] 实现请求频率限制
- [ ] 单用户 10 分钟 20 次
- [ ] 返回 429 状态码
- [ ] 友好的限流提示

---

## 📊 监控与优化

### 成本监控
- [ ] 记录 Token 使用量
- [ ] 统计 API 调用次数
- [ ] 计算预估费用
- [ ] 设置费用告警

### 性能优化
- [ ] 压缩文档内容（提取关键部分）
- [ ] 限制对话历史长度（最近 10 条）
- [ ] 使用更快的模型（glm-4-flash）
- [ ] 实现响应缓存

### 日志记录
- [ ] API 请求日志
- [ ] 错误日志
- [ ] 性能指标
- [ ] 用户行为日志

---

## 🚀 部署

### 准备部署
- [ ] 更新生产环境变量
- [ ] 配置 CORS 白名单
- [ ] 设置文件上传路径
- [ ] 配置数据库（如需要）

### 部署检查
- [ ] 前端构建成功
- [ ] 后端构建成功
- [ ] 环境变量配置正确
- [ ] API 连通性测试

### 上线后检查
- [ ] API 响应正常
- [ ] 文件上传功能正常
- [ ] 聊天功能正常
- [ ] 流式响应正常
- [ ] 错误处理正常

---

## 📝 文档更新

### 代码文档
- [ ] 更新 API 接口文档
- [ ] 更新 README.md
- [ ] 更新 FRONTEND_BACKEND_GUIDE.md
- [ ] 添加使用示例

### 运维文档
- [ ] 环境变量说明
- [ ] 部署步骤
- [ ] 监控指标
- [ ] 故障排查指南

---

## ✅ 验收标准

### 功能完整性
- [ ] 用户可以上传文档
- [ ] AI 可以理解文档内容
- [ ] AI 提供渐进式提示（3 个等级）
- [ ] 支持多轮对话
- [ ] 流式响应流畅

### 性能指标
- [ ] API 响应时间 < 3 秒
- [ ] 首字延迟 < 500ms（流式）
- [ ] 文件解析 < 5 秒（10MB PDF）
- [ ] 支持 10+ 并发用户

### 安全标准
- [ ] API Key 安全存储
- [ ] 无 XSS/注入漏洞
- [ ] 文件上传安全
- [ ] Rate Limiting 生效

### 用户体验
- [ ] 界面响应流畅
- [ ] 错误提示友好
- [ ] 加载状态清晰
- [ ] Markdown 渲染正确

---

**进度跟踪**: 0 / 100+ 项完成

**预计完成时间**: 5-7 天

**当前状态**: 📋 准备阶段
