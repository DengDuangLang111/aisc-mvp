# å‰åç«¯äº¤äº’è¯¦è§£ - Study Oasis

## ğŸ“š ç›®å½•
1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ–‡ä»¶ä¸Šä¼ æµç¨‹](#æ–‡ä»¶ä¸Šä¼ æµç¨‹)
3. [AI å¯¹è¯æµç¨‹](#ai-å¯¹è¯æµç¨‹)
4. [æŠ€æœ¯æ ˆè¯¦è§£](#æŠ€æœ¯æ ˆè¯¦è§£)
5. [æ•°æ®æµåŠ¨å›¾](#æ•°æ®æµåŠ¨å›¾)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æµè§ˆå™¨ (Browser)                     â”‚
â”‚  http://localhost:3000                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Next.js å‰ç«¯åº”ç”¨ (React)                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚  é¦–é¡µ    â”‚  â”‚ ä¸Šä¼ é¡µé¢  â”‚  â”‚ èŠå¤©é¡µé¢  â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  /       â”‚  â”‚ /upload   â”‚  â”‚ /chat    â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP Requests
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NestJS åç«¯æœåŠ¡å™¨ (Backend)                  â”‚
â”‚              http://localhost:4000                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              API ç«¯ç‚¹ (Endpoints)                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ GET  /         - å¥åº·æ£€æŸ¥                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ POST /upload   - æ–‡ä»¶ä¸Šä¼                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ POST /chat     - AI å¯¹è¯                  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚            ä¸šåŠ¡é€»è¾‘å±‚                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ UploadService  - æ–‡ä»¶å¤„ç†              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ ChatService    - AI å¯¹è¯é€»è¾‘           â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚           æ–‡ä»¶å­˜å‚¨ (Storage)               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚       apps/api/uploads/                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ UUID-å‘½åçš„ä¸Šä¼ æ–‡ä»¶                     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æµç¨‹è¯¦è§£

### æ­¥éª¤ 1: ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ï¼ˆå‰ç«¯ï¼‰

**ä½ç½®**: `/study_oasis_simple/apps/web/app/upload/page.tsx`

```tsx
// ç”¨æˆ·ç‚¹å‡»æ–‡ä»¶é€‰æ‹©å™¨
<input
  ref={fileRef}
  type="file"
  onChange={() => {
    setStatus("");
    setUploadedFile(null);
  }}
/>
```

**å‘ç”Ÿäº†ä»€ä¹ˆ**:
1. ç”¨æˆ·ç‚¹å‡» "é€‰æ‹©æ–‡ä»¶" æŒ‰é’®
2. æµè§ˆå™¨æ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
3. ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ¯”å¦‚ `study.pdf`ï¼‰
4. æ–‡ä»¶å¯¹è±¡å­˜å‚¨åœ¨ `fileRef.current.files[0]`

---

### æ­¥éª¤ 2: ç”¨æˆ·ç‚¹å‡»ä¸Šä¼ ï¼ˆå‰ç«¯ï¼‰

```tsx
async function handleUpload() {
  const file = fileRef.current?.files?.[0];
  if (!file) {
    setStatus("è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶");
    return;
  }

  // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
  setStatus(`æ­£åœ¨ä¸Šä¼ ï¼š${file.name}...`);
  setUploading(true);

  // åˆ›å»º FormData å¯¹è±¡ï¼ˆé‡è¦ï¼ï¼‰
  const fd = new FormData();
  fd.append("file", file);
  
  // ...
}
```

**FormData çš„ä½œç”¨**:
- `FormData` æ˜¯æµè§ˆå™¨æä¾›çš„ APIï¼Œç”¨äºæ„å»º `multipart/form-data` æ ¼å¼çš„æ•°æ®
- è¿™æ˜¯**å”¯ä¸€æ­£ç¡®çš„æ–¹å¼**æ¥ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚ PDFã€å›¾ç‰‡ç­‰ï¼‰
- ä¸èƒ½ç”¨ JSON å‘é€æ–‡ä»¶ï¼

**ä¸ºä»€ä¹ˆç”¨ multipart/form-dataï¼Ÿ**
```
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="study.pdf"
Content-Type: application/pdf

[äºŒè¿›åˆ¶æ–‡ä»¶å†…å®¹...]
------WebKitFormBoundary7MA4YWxkTrZu0gW--
```

---

### æ­¥éª¤ 3: å‘é€ HTTP è¯·æ±‚åˆ°åç«¯

```tsx
try {
  const res = await fetch("http://localhost:4000/upload", {
    method: "POST",
    body: fd,  // ç›´æ¥ä¼  FormDataï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è®¾ç½® Content-Type
  });

  if (!res.ok) {
    throw new Error(`ä¸Šä¼ å¤±è´¥: ${res.statusText}`);
  }

  const json = await res.json();
  // json = { id: "uuid", filename: "study.pdf", url: "..." }
}
```

**HTTP è¯·æ±‚è¯¦æƒ…**:
```http
POST http://localhost:4000/upload HTTP/1.1
Host: localhost:4000
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Length: 245678

[FormData å†…å®¹...]
```

---

### æ­¥éª¤ 4: åç«¯æ¥æ”¶æ–‡ä»¶ï¼ˆNestJSï¼‰

**ä½ç½®**: `/apps/api/src/upload/upload.controller.ts`

```typescript
@Controller('upload')
export class UploadController {
  @Post()
  @UseInterceptors(
    FileInterceptor('file', {  // â† 'file' å¿…é¡»å’Œå‰ç«¯ fd.append('file', ...) çš„åå­—ä¸€è‡´
      storage: diskStorage({
        destination: './uploads',  // å­˜å‚¨ç›®å½•
        filename: (req, file, cb) => {
          const uniqueId = randomUUID();  // ç”Ÿæˆ UUID
          const ext = extname(file.originalname);  // è·å–æ‰©å±•å
          cb(null, `${uniqueId}${ext}`);  // æœ€ç»ˆæ–‡ä»¶å: abc123-def456.pdf
        },
      }),
    }),
  )
  uploadFile(@UploadedFile() file: Express.Multer.File) {
    // file å¯¹è±¡åŒ…å«ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯
    return {
      id: file.filename.replace(extname(file.filename), ''),
      filename: file.originalname,
      url: `http://localhost:4000/uploads/${file.filename}`,
    };
  }
}
```

**Multer ä¸­é—´ä»¶çš„ä½œç”¨**:
1. **è§£æ multipart/form-data**ï¼šæå–æ–‡ä»¶å’Œè¡¨å•å­—æ®µ
2. **ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜**ï¼šæŒ‰ç…§é…ç½®ä¿å­˜åˆ° `./uploads/` ç›®å½•
3. **ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å**ï¼šé¿å…æ–‡ä»¶åå†²çª
4. **å¡«å…… file å¯¹è±¡**ï¼šæä¾›ç»™æ§åˆ¶å™¨ä½¿ç”¨

**file å¯¹è±¡ç»“æ„**:
```typescript
{
  fieldname: 'file',
  originalname: 'study.pdf',
  encoding: '7bit',
  mimetype: 'application/pdf',
  destination: './uploads',
  filename: '9c7f7648-75b9-44e2-a123-0866de434e62.pdf',
  path: 'uploads/9c7f7648-75b9-44e2-a123-0866de434e62.pdf',
  size: 245678
}
```

---

### æ­¥éª¤ 5: è¿”å›å“åº”ç»™å‰ç«¯

**åç«¯è¿”å›çš„ JSON**:
```json
{
  "id": "9c7f7648-75b9-44e2-a123-0866de434e62",
  "filename": "study.pdf",
  "url": "http://localhost:4000/uploads/9c7f7648-75b9-44e2-a123-0866de434e62.pdf"
}
```

**å‰ç«¯æ¥æ”¶å“åº”**:
```tsx
const json = await res.json();
console.log("åç«¯è¿”å›ï¼š", json);
setUploadedFile(json);  // ä¿å­˜æ–‡ä»¶ä¿¡æ¯
setStatus(`âœ… ä¸Šä¼ æˆåŠŸï¼æ–‡ä»¶ï¼š${json.filename}`);
```

---

### æ­¥éª¤ 6: æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯å’Œè·³è½¬æŒ‰é’®

```tsx
{uploadedFile && (
  <div className="border-t pt-4 space-y-3">
    <div className="text-sm text-gray-600">
      <p><span className="font-medium">æ–‡ä»¶åï¼š</span>{uploadedFile.filename}</p>
      <p><span className="font-medium">æ–‡ä»¶ IDï¼š</span>{uploadedFile.id}</p>
    </div>

    <Button onClick={handleStartChat} variant="primary" className="w-full">
      å¼€å§‹å¯¹è¯å­¦ä¹  â†’
    </Button>
  </div>
)}
```

---

### æ­¥éª¤ 7: è·³è½¬åˆ°èŠå¤©é¡µé¢

```tsx
function handleStartChat() {
  if (uploadedFile) {
    router.push(`/chat?fileId=${uploadedFile.id}&filename=${encodeURIComponent(uploadedFile.filename)}`);
  } else {
    router.push('/chat');
  }
}
```

**URL ç¤ºä¾‹**:
```
http://localhost:3000/chat?fileId=9c7f7648-75b9-44e2-a123-0866de434e62&filename=study.pdf
```

---

## ğŸ’¬ AI å¯¹è¯æµç¨‹è¯¦è§£

### æ­¥éª¤ 1: èŠå¤©é¡µé¢åˆå§‹åŒ–ï¼ˆå‰ç«¯ï¼‰

**ä½ç½®**: `/study_oasis_simple/apps/web/app/chat/page.tsx`

```tsx
'use client';

export default function ChatPage() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [loading, setLoading] = useState(false);
  
  // å¯ä»¥ä» URL è·å–æ–‡ä»¶ä¿¡æ¯
  // const searchParams = useSearchParams();
  // const fileId = searchParams.get('fileId');
  // const filename = searchParams.get('filename');
}
```

---

### æ­¥éª¤ 2: ç”¨æˆ·è¾“å…¥é—®é¢˜å¹¶å‘é€

```tsx
async function handleSend() {
  if (!inputValue.trim() || loading) return;

  // 1. åˆ›å»ºç”¨æˆ·æ¶ˆæ¯å¯¹è±¡
  const userMessage: Message = {
    id: Date.now().toString(),
    role: 'user',
    content: inputValue,
    timestamp: new Date().toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit',
    }),
  };

  // 2. ç«‹å³æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼ˆä¹è§‚æ›´æ–°ï¼‰
  setMessages((prev) => [...prev, userMessage]);
  setInputValue('');  // æ¸…ç©ºè¾“å…¥æ¡†
  setLoading(true);   // æ˜¾ç¤ºåŠ è½½çŠ¶æ€

  // 3. å‘é€ HTTP è¯·æ±‚åˆ°åç«¯
  try {
    const response = await fetch('http://localhost:4000/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',  // â† å‘é€ JSON
      },
      body: JSON.stringify({
        message: inputValue,
        conversationHistory: messages,  // å¯é€‰ï¼šå‘é€å¯¹è¯å†å²
      }),
    });

    // ...
  }
}
```

**HTTP è¯·æ±‚è¯¦æƒ…**:
```http
POST http://localhost:4000/chat HTTP/1.1
Host: localhost:4000
Content-Type: application/json
Content-Length: 156

{
  "message": "ä»€ä¹ˆæ˜¯é‡å­åŠ›å­¦ï¼Ÿ",
  "conversationHistory": [
    { "role": "user", "content": "ä½ å¥½", "timestamp": "14:30" },
    { "role": "assistant", "content": "ä½ å¥½ï¼", "hintLevel": 1, "timestamp": "14:30" }
  ]
}
```

---

### æ­¥éª¤ 3: åç«¯å¤„ç† AI è¯·æ±‚

**ä½ç½®**: `/apps/api/src/chat/chat.controller.ts`

```typescript
@Controller('chat')
export class ChatController {
  constructor(private readonly chatService: ChatService) {}

  @Post()
  async chat(@Body() body: { message: string; conversationHistory?: any[] }) {
    return this.chatService.processMessage(body.message, body.conversationHistory);
  }
}
```

**ä½ç½®**: `/apps/api/src/chat/chat.service.ts`

```typescript
@Injectable()
export class ChatService {
  processMessage(message: string, history?: any[]): ChatResponse {
    // 1. åˆ†ææ¶ˆæ¯å†…å®¹
    const messageLength = message.length;
    
    // 2. æ ¹æ®å†…å®¹é•¿åº¦å†³å®šæç¤ºç­‰çº§ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
    let hintLevel: HintLevel;
    if (messageLength < 10) {
      hintLevel = 1;  // çŸ­æ¶ˆæ¯ -> è½»åº¦æç¤º
    } else if (messageLength < 30) {
      hintLevel = 2;  // ä¸­ç­‰æ¶ˆæ¯ -> ä¸­åº¦æç¤º
    } else {
      hintLevel = 3;  // é•¿æ¶ˆæ¯ -> è¯¦ç»†æç¤º
    }

    // 3. ç”Ÿæˆä¸åŒç­‰çº§çš„å›å¤å†…å®¹
    const responses = {
      1: `ğŸ¤” å…³äº"${message}"ï¼Œä½ å¯ä»¥å…ˆæ€è€ƒä¸€ä¸‹è¿™ä¸ªæ–¹å‘...`,
      2: `ğŸ’¡ è®©æˆ‘ç»™ä½ ä¸€äº›æç¤ºï¼šé¦–å…ˆè€ƒè™‘...ç„¶å...`,
      3: `âœ¨ è¯¦ç»†è§£ç­”ï¼š${message}çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯...å®Œæ•´çš„ç†è§£åŒ…æ‹¬...`,
    };

    // 4. è¿”å›å“åº”
    return {
      message: responses[hintLevel],
      hintLevel: hintLevel,
      timestamp: new Date().toISOString(),
    };
  }
}
```

**å®é™…åº”ç”¨ä¸­å¯èƒ½çš„æ”¹è¿›**:
- è°ƒç”¨çœŸå®çš„ AI APIï¼ˆOpenAIã€Claude ç­‰ï¼‰
- æ ¹æ®æ–‡ä»¶å†…å®¹æä¾›ä¸Šä¸‹æ–‡
- ä½¿ç”¨å‘é‡æ•°æ®åº“å­˜å‚¨æ–‡ä»¶çŸ¥è¯†
- å®ç°å¯¹è¯å†å²è®°å¿†

---

### æ­¥éª¤ 4: è¿”å› AI å“åº”

**åç«¯è¿”å›çš„ JSON**:
```json
{
  "message": "ğŸ¤” å…³äº\"ä»€ä¹ˆæ˜¯é‡å­åŠ›å­¦ï¼Ÿ\"ï¼Œä½ å¯ä»¥å…ˆæ€è€ƒä¸€ä¸‹è¿™ä¸ªæ–¹å‘...",
  "hintLevel": 1,
  "timestamp": "2025-10-29T14:30:15.123Z"
}
```

---

### æ­¥éª¤ 5: å‰ç«¯æ˜¾ç¤º AI å›å¤

```tsx
const response = await fetch('http://localhost:4000/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ message: inputValue }),
});

const data = await response.json();

// åˆ›å»º AI æ¶ˆæ¯å¯¹è±¡
const aiMessage: Message = {
  id: (Date.now() + 1).toString(),
  role: 'assistant',
  content: data.message,
  hintLevel: data.hintLevel,
  timestamp: new Date().toLocaleTimeString('zh-CN', {
    hour: '2-digit',
    minute: '2-digit',
  }),
};

// æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
setMessages((prev) => [...prev, aiMessage]);
setLoading(false);
```

---

### æ­¥éª¤ 6: æ¶ˆæ¯åˆ—è¡¨è‡ªåŠ¨æ»šåŠ¨

**ä½ç½®**: `/study_oasis_simple/apps/web/app/chat/components/MessageList.tsx`

```tsx
export function MessageList({ messages }: MessageListProps) {
  const bottomRef = useRef<HTMLDivElement>(null);

  // æ¯æ¬¡æ¶ˆæ¯æ›´æ–°æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  return (
    <div className="flex-1 overflow-y-auto p-4 space-y-4">
      {messages.map((message) => (
        <MessageBubble key={message.id} message={message} />
      ))}
      <div ref={bottomRef} />  {/* æ»šåŠ¨é”šç‚¹ */}
    </div>
  );
}
```

---

## ğŸ”§ æŠ€æœ¯æ ˆè¯¦è§£

### å‰ç«¯ (Next.js + React)

```
Next.js 16.0.1
â”œâ”€â”€ React 19.2.0                 - UI æ¡†æ¶
â”œâ”€â”€ TypeScript 5                 - ç±»å‹å®‰å…¨
â”œâ”€â”€ Tailwind CSS 4               - æ ·å¼ç³»ç»Ÿ
â”œâ”€â”€ Jest + React Testing Library - å•å…ƒæµ‹è¯•
â””â”€â”€ pnpm                         - åŒ…ç®¡ç†å™¨
```

**å…³é”®æ¦‚å¿µ**:
- **Client Components** (`'use client'`): å¯ä»¥ä½¿ç”¨ hooksã€äº‹ä»¶å¤„ç†
- **Server Components** (é»˜è®¤): åœ¨æœåŠ¡å™¨æ¸²æŸ“ï¼Œæ€§èƒ½æ›´å¥½
- **App Router**: åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”±

---

### åç«¯ (NestJS)

```
NestJS 11.1.8
â”œâ”€â”€ TypeScript                   - ç±»å‹å®‰å…¨
â”œâ”€â”€ Express.js (åº•å±‚)            - HTTP æœåŠ¡å™¨
â”œâ”€â”€ Multer                       - æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
â”œâ”€â”€ CORS                         - è·¨åŸŸèµ„æºå…±äº«
â””â”€â”€ Node.js                      - è¿è¡Œæ—¶ç¯å¢ƒ
```

**æ¶æ„æ¨¡å¼**:
```
Controller (è·¯ç”±å±‚)
    â†“
Service (ä¸šåŠ¡é€»è¾‘å±‚)
    â†“
æ•°æ®è®¿é—®å±‚ (æœªæ¥å¯æ‰©å±•)
```

---

## ğŸ“Š æ•°æ®æµåŠ¨å›¾

### å®Œæ•´ç”¨æˆ·æ—…ç¨‹

```
ç”¨æˆ·æ‰“å¼€æµè§ˆå™¨
    â†“
è®¿é—® http://localhost:3000
    â†“
çœ‹åˆ°é¦–é¡µï¼Œç‚¹å‡»"ä¸Šä¼ å­¦ä¹ ææ–™"
    â†“
è·³è½¬åˆ° /upload é¡µé¢
    â†“
1. é€‰æ‹©æ–‡ä»¶ (study.pdf)
    â†“
2. ç‚¹å‡»"ä¸Šä¼ æ–‡ä»¶"
    â†“
3. å‰ç«¯åˆ›å»º FormData
   fd.append('file', file)
    â†“
4. å‘é€ POST è¯·æ±‚åˆ° http://localhost:4000/upload
    â†“
5. åç«¯ Multer è§£ææ–‡ä»¶
    â†“
6. ä¿å­˜åˆ° ./uploads/uuid.pdf
    â†“
7. è¿”å› { id, filename, url }
    â†“
8. å‰ç«¯æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    â†“
9. ç”¨æˆ·ç‚¹å‡»"å¼€å§‹å¯¹è¯å­¦ä¹ "
    â†“
10. è·³è½¬åˆ° /chat?fileId=uuid&filename=study.pdf
    â†“
11. ç”¨æˆ·è¾“å…¥é—®é¢˜ï¼š"é‡å­åŠ›å­¦æ˜¯ä»€ä¹ˆï¼Ÿ"
    â†“
12. å‰ç«¯å‘é€ POST åˆ° http://localhost:4000/chat
    body: { message: "é‡å­åŠ›å­¦æ˜¯ä»€ä¹ˆï¼Ÿ" }
    â†“
13. åç«¯ ChatService å¤„ç†
    â†“
14. è¿”å› { message: "ğŸ¤” æç¤º...", hintLevel: 1 }
    â†“
15. å‰ç«¯æ˜¾ç¤º AI å›å¤
    â†“
16. MessageList è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    â†“
ç”¨æˆ·å¯ä»¥ç»§ç»­æé—®...
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. è·¨åŸŸè¯·æ±‚ (CORS)

**é—®é¢˜**: å‰ç«¯ (localhost:3000) æ— æ³•ç›´æ¥è¯·æ±‚åç«¯ (localhost:4000)

**è§£å†³**: åç«¯å¯ç”¨ CORS

```typescript
// main.ts
app.enableCors({
  origin: 'http://localhost:3000',  // å…è®¸çš„å‰ç«¯åœ°å€
  credentials: true,
});
```

---

### 2. FormData vs JSON

| åœºæ™¯ | ä½¿ç”¨ |
|------|------|
| ä¸Šä¼ æ–‡ä»¶ | FormData + multipart/form-data |
| å‘é€æ–‡æœ¬/å¯¹è±¡ | JSON + application/json |

**é”™è¯¯ç¤ºä¾‹**:
```tsx
// âŒ ä¸èƒ½ç”¨ JSON å‘é€æ–‡ä»¶
await fetch('/upload', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ file: file })  // ä¸èµ·ä½œç”¨ï¼
});
```

**æ­£ç¡®ç¤ºä¾‹**:
```tsx
// âœ… ä½¿ç”¨ FormData
const fd = new FormData();
fd.append('file', file);
await fetch('/upload', {
  method: 'POST',
  body: fd,  // æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ Content-Type
});
```

---

### 3. çŠ¶æ€ç®¡ç†

**React çš„çŠ¶æ€ç®¡ç†**:
```tsx
const [messages, setMessages] = useState<Message[]>([]);

// æ·»åŠ æ–°æ¶ˆæ¯ï¼ˆä¸å¯å˜æ›´æ–°ï¼‰
setMessages((prev) => [...prev, newMessage]);

// âŒ é”™è¯¯ï¼šç›´æ¥ä¿®æ”¹çŠ¶æ€
messages.push(newMessage);  // ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼

// âœ… æ­£ç¡®ï¼šåˆ›å»ºæ–°æ•°ç»„
setMessages([...messages, newMessage]);
```

---

### 4. å¼‚æ­¥æ“ä½œ

**async/await æ¨¡å¼**:
```tsx
async function handleSend() {
  setLoading(true);
  try {
    const response = await fetch('/chat', { ... });
    const data = await response.json();
    // å¤„ç†æ•°æ®
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥', error);
    setError('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    setLoading(false);  // æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
  }
}
```

---

## ğŸ¯ æ€»ç»“

### ä¸Šä¼ æµç¨‹
1. **å‰ç«¯**: ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â†’ åˆ›å»º FormData â†’ å‘é€ POST è¯·æ±‚
2. **åç«¯**: Multer æ¥æ”¶æ–‡ä»¶ â†’ ç”Ÿæˆ UUID â†’ ä¿å­˜åˆ°ç£ç›˜ â†’ è¿”å›æ–‡ä»¶ä¿¡æ¯
3. **å‰ç«¯**: æ˜¾ç¤ºä¸Šä¼ æˆåŠŸ â†’ è·³è½¬åˆ°èŠå¤©é¡µé¢

### å¯¹è¯æµç¨‹
1. **å‰ç«¯**: ç”¨æˆ·è¾“å…¥é—®é¢˜ â†’ å‘é€ JSON è¯·æ±‚ â†’ æ˜¾ç¤ºåŠ è½½çŠ¶æ€
2. **åç«¯**: æ¥æ”¶æ¶ˆæ¯ â†’ å¤„ç†é€»è¾‘ â†’ ç”Ÿæˆå›å¤ â†’ è¿”å› JSON
3. **å‰ç«¯**: æ¥æ”¶å›å¤ â†’ æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ â†’ è‡ªåŠ¨æ»šåŠ¨

### æ ¸å¿ƒæŠ€æœ¯
- **HTTP é€šä¿¡**: fetch API
- **æ–‡ä»¶ä¸Šä¼ **: FormData + Multer
- **çŠ¶æ€ç®¡ç†**: React Hooks (useState, useEffect, useRef)
- **ç±»å‹å®‰å…¨**: TypeScript
- **æ ·å¼**: Tailwind CSS

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ29æ—¥
**ç‰ˆæœ¬**: v1.0.0
